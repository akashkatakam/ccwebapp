{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Parameters":{  
      "KeyPair":{  
         "Type":"AWS::EC2::KeyPair::KeyName"
      },
      "NetworkStackName":{  
         "Type":"String"
      },
      "PolicyStackName":{  
         "Type":"String"
      },
      "ImageID":{  
         "Type":"AWS::EC2::Image::Id"
      },
      "DBUsername":{  
         "Default":"csye6225master",
         "Description":"Database Username",
         "Type":"String"
      },
      "DBPassword":{  
         "Default":"csye6225password",
         "Description":"Database Password",
         "Type":"String"
      },
      "S3Bucket":{  
         "Type":"String"
      }
   },
   "Resources":{  
      "WebServerSecurityGroup":{  
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{  
            "GroupDescription":"Enable HTTP access via port 80, SSH access via port 22",
            "SecurityGroupIngress":[  
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "SourceSecurityGroupId":{  
                     "Ref":"loadBalancerSecurityGroup"
                  }
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"8080",
                  "ToPort":"8080",
                  "SourceSecurityGroupId":{  
                     "Ref":"loadBalancerSecurityGroup"
                  }
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"80",
                  "ToPort":"80",
                  "CidrIp":"0.0.0.0/0"
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"22",
                  "ToPort":"22",
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "VpcId":{  
               "Fn::ImportValue":{  
                  "Fn::Join":[  
                     "",
                     [  
                        {  
                           "Ref":"NetworkStackName"
                        },
                        "-vpcID"
                     ]
                  ]
               }
            }
         },
         "DependsOn":"loadBalancerSecurityGroup"
      },
      "DbSecurityGroup":{  
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{  
            "GroupDescription":"Security tag for db",
            "SecurityGroupIngress":[  
               {  
                  "SourceSecurityGroupId":{  
                     "Ref":"WebServerSecurityGroup"
                  },
                  "FromPort":3306,
                  "IpProtocol":"tcp",
                  "ToPort":3306
               }
            ],
            "VpcId":{  
               "Fn::ImportValue":{  
                  "Fn::Join":[  
                     "",
                     [  
                        {  
                           "Ref":"NetworkStackName"
                        },
                        "-vpcID"
                     ]
                  ]
               }
            },
            "Tags":[  
               {  
                  "Key":"Name",
                  "Value":{  
                     "Fn::Join":[  
                        "-",
                        [  
                           {  
                              "Ref":"AWS::StackName"
                           },
                           "DbSecurityGroup"
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "ApplicationLoadBalancer":{  
         "Type":"AWS::ElasticLoadBalancingV2::LoadBalancer",
         "Properties":{  
            "IpAddressType":"ipv4",
            "SecurityGroups":[  
               {  
                  "Ref":"loadBalancerSecurityGroup"
               }
            ],
            "Subnets":[  
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet1"
                        ]
                     ]
                  }
               },
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet2"
                        ]
                     ]
                  }
               }
            ],
            "Name":"ApplicationLoadBalancer",
            "Scheme":"internet-facing",
            "Tags":[  
               {  
                  "Key":"Name",
                  "Value":"Loadbalancer"
               }
            ],
            "Type":"application"
         }
      },
      "ApplicationLoadBalancer2":{  
         "Type":"AWS::ElasticLoadBalancingV2::LoadBalancer",
         "Properties":{  
            "IpAddressType":"ipv4",
            "SecurityGroups":[  
               {  
                  "Ref":"loadBalancerSecurityGroup"
               }
            ],
            "Subnets":[  
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet1"
                        ]
                     ]
                  }
               },
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet2"
                        ]
                     ]
                  }
               }
            ],
            "Name":"ApplicationLoadBalancer2",
            "Scheme":"internet-facing",
            "Tags":[  
               {  
                  "Key":"Name",
                  "Value":"Loadbalancer"
               }
            ],
            "Type":"application"
         }
      },
      "autoscalinglaunchconfig":{  
         "Type":"AWS::AutoScaling::LaunchConfiguration",
         "Properties":{  
            "ImageId":{  
               "Ref":"ImageID"
            },
            "KeyName":{  
               "Ref":"KeyPair"
            },
            "InstanceType":"t2.micro",
            "IamInstanceProfile":{  
               "Fn::ImportValue":{  
                  "Fn::Join":[  
                     "",
                     [  
                        {  
                           "Ref":"PolicyStackName"
                        },
                        "-CodeDeployEC2InstanceProfile"
                     ]
                  ]
               }
            },
            "BlockDeviceMappings":[  
               {  
                  "DeviceName":"/dev/sda1",
                  "Ebs":{  
                     "VolumeType":"gp2",
                     "DeleteOnTermination":"true",
                     "VolumeSize":"20"
                  }
               }
            ],
            "SecurityGroups":[  
               {  
                  "Ref":"WebServerSecurityGroup"
               }
            ],
            "LaunchConfigurationName":"autoscaling_launch_configuration",
            "AssociatePublicIpAddress":true
         }
      },
      "loadBalancerSecurityGroup":{  
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{  
            "GroupDescription":"Enable HTTP access via port 80, SSH access via port 22",
            "SecurityGroupIngress":[  
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "CidrIp":"0.0.0.0/0"
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"8080",
                  "ToPort":"8080",
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "VpcId":{  
               "Fn::ImportValue":{  
                  "Fn::Join":[  
                     "",
                     [  
                        {  
                           "Ref":"NetworkStackName"
                        },
                        "-vpcID"
                     ]
                  ]
               }
            }
         }
      },
      "ALBTargetGroup":{  
         "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties":{  
            "HealthCheckIntervalSeconds":30,
            "HealthCheckPath":"/",
            "HealthCheckPort":"8080",
            "HealthCheckProtocol":"HTTP",
            "HealthCheckTimeoutSeconds":7,
            "HealthyThresholdCount":3,
            "Name":"ALBTargetGroup",
            "Port":8080,
            "Protocol":"HTTP",
            "TargetType":"instance",
            "UnhealthyThresholdCount":5,
            "VpcId":{  
               "Fn::ImportValue":{  
                  "Fn::Join":[  
                     "",
                     [  
                        {  
                           "Ref":"NetworkStackName"
                        },
                        "-vpcID"
                     ]
                  ]
               }
            },
            "Matcher":{  
               "HttpCode":"401"
            }
         }
      },
      "ALBTargetGroup1":{  
         "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties":{  
            "HealthCheckIntervalSeconds":30,
            "HealthCheckPath":"/",
            "HealthCheckPort":"8080",
            "HealthCheckProtocol":"HTTP",
            "HealthCheckTimeoutSeconds":7,
            "HealthyThresholdCount":3,
            "Name":"ALBTargetGroup1",
            "Port":8080,
            "Protocol":"HTTP",
            "TargetType":"instance",
            "UnhealthyThresholdCount":5,
            "VpcId":{  
               "Fn::ImportValue":{  
                  "Fn::Join":[  
                     "",
                     [  
                        {  
                           "Ref":"NetworkStackName"
                        },
                        "-vpcID"
                     ]
                  ]
               }
            },
            "Matcher":{  
               "HttpCode":"401"
            }
         }
      },
      "WebServerGroup":{  
         "Type":"AWS::AutoScaling::AutoScalingGroup",
         "Properties":{  
            "AutoScalingGroupName":"WebServerGroup",
            "Cooldown":"10",
            "LaunchConfigurationName":{  
               "Ref":"autoscalinglaunchconfig"
            },
            "MaxSize":"10",
            "MinSize":"3",
            "DesiredCapacity":"3",
            "HealthCheckType":"EC2",
            "HealthCheckGracePeriod":60,
            "Tags":[  
               {  
                  "Key":"codeDeployKey",
                  "Value":"codeDeployValue",
                  "PropagateAtLaunch":true
               }
            ],
            "TargetGroupARNs":[  
               {  
                  "Ref":"ALBTargetGroup"
               },
               {  
                  "Ref":"ALBTargetGroup1"
               }
            ],
            "VPCZoneIdentifier":[  
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet1"
                        ]
                     ]
                  }
               },
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet2"
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "WebServerScaleUpPolicy":{  
         "Type":"AWS::AutoScaling::ScalingPolicy",
         "Properties":{  
            "AdjustmentType":"ChangeInCapacity",
            "AutoScalingGroupName":{  
               "Ref":"WebServerGroup"
            },
            "Cooldown":"10",
            "ScalingAdjustment":"1"
         }
      },
      "WebServerScaleDownPolicy":{  
         "Type":"AWS::AutoScaling::ScalingPolicy",
         "Properties":{  
            "AdjustmentType":"ChangeInCapacity",
            "AutoScalingGroupName":{  
               "Ref":"WebServerGroup"
            },
            "Cooldown":"10",
            "ScalingAdjustment":"-1"
         }
      },
      "CPUAlarmHigh":{  
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{  
            "AlarmDescription":"Scale-up if CPU > 10% for 2 minutes",
            "MetricName":"CPUUtilization",
            "Namespace":"AWS/EC2",
            "Statistic":"Average",
            "Period":"60",
            "EvaluationPeriods":"2",
            "Threshold":"10",
            "AlarmActions":[  
               {  
                  "Ref":"WebServerScaleUpPolicy"
               }
            ],
            "Dimensions":[  
               {  
                  "Name":"AutoScalingGroupName",
                  "Value":{  
                     "Ref":"WebServerGroup"
                  }
               }
            ],
            "ComparisonOperator":"GreaterThanThreshold",
            "Unit":"Percent"
         }
      },
      "CPUAlarmLow":{  
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{  
            "AlarmDescription":"Scale-down if CPU < 5% for 2 minutes",
            "MetricName":"CPUUtilization",
            "Namespace":"AWS/EC2",
            "Statistic":"Average",
            "Period":"60",
            "EvaluationPeriods":"2",
            "Threshold":"5",
            "AlarmActions":[  
               {  
                  "Ref":"WebServerScaleDownPolicy"
               }
            ],
            "Dimensions":[  
               {  
                  "Name":"AutoScalingGroupName",
                  "Value":{  
                     "Ref":"WebServerGroup"
                  }
               }
            ],
            "ComparisonOperator":"LessThanThreshold",
            "Unit":"Percent"
         }
      },
      "DBSubnetGroup":{  
         "Type":"AWS::RDS::DBSubnetGroup",
         "Properties":{  
            "DBSubnetGroupDescription":"DB Subnet Group",
            "DBSubnetGroupName":{  
               "Fn::Join":[  
                  "",
                  [  
                     "SubnetGroup",
                     {  
                        "Ref":"AWS::StackName"
                     }
                  ]
               ]
            },
            "SubnetIds":[  
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet1"
                        ]
                     ]
                  }
               },
               {  
                  "Fn::ImportValue":{  
                     "Fn::Join":[  
                        "",
                        [  
                           {  
                              "Ref":"NetworkStackName"
                           },
                           "-dbSubnet2"
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "CodeDeployApplication":{  
         "Type":"AWS::CodeDeploy::Application",
         "Properties":{  
            "ApplicationName":"csye6225-webapp",
            "ComputePlatform":"Server"
         }
      },
      "DeploymentGroup":{  
         "Type":"AWS::CodeDeploy::DeploymentGroup",
         "DependsOn":"CodeDeployApplication",
         "Properties":{  
            "ApplicationName":{  
               "Ref":"CodeDeployApplication"
            },
            "DeploymentGroupName":"csye6225-webapp-deployment",
            "DeploymentStyle":{  
               "DeploymentOption":"WITHOUT_TRAFFIC_CONTROL",
               "DeploymentType":"IN_PLACE"
            },
            "AutoRollbackConfiguration":{  
               "Enabled":"true",
               "Events":[  
                  "DEPLOYMENT_FAILURE"
               ]
            },
            "DeploymentConfigName":"CodeDeployDefault.AllAtOnce",
            "Ec2TagFilters":[  
               {  
                  "Key":"Name",
                  "Type":"KEY_AND_VALUE",
                  "Value":{  
                     "Fn::Join":[  
                        "-",
                        [  
                           {  
                              "Ref":"AWS::StackName"
                           },
                           "ec2"
                        ]
                     ]
                  }
               }
            ],
            "ServiceRoleArn":{  
               "Fn::ImportValue":{  
                  "Fn::Join":[  
                     "",
                     [  
                        {  
                           "Ref":"PolicyStackName"
                        },
                        "-CodeDeployServiceRoleArn"
                     ]
                  ]
               }
            }
         }
      }
   }
}
