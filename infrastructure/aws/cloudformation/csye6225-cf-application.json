{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Parameters": {
		"KeyPair": {
			"Type": "String"
		},
		"ImageID": {
			"Type": "String"
		},
		"DBUsername": {
			"Default": "csye6225master",
			"Description": "Database Username",
			"Type": "String"
		},
		"DBPassword": {
			"Default": "csye6225password",
			"Description": "Database Password",
			"Type": "String"
		}
	},
	"Resources": {
		
	},
	"DbSecurityGroup": {
		"Type": "AWS::EC2::SecurityGroup",
		"Properties": {
			"GroupDescription": "Security tag for db",
			"SecurityGroupIngress": [
				{
					"SourceSecurityGroupId": {
						"Ref": "WebServerSecurityGroup"
					},
					"FromPort": 3306,
					"IpProtocol": "tcp",
					"ToPort": 3306
				}
			],
			"VpcId": {
				"Fn::ImportValue": "vpcID"
			},
			"Tags": [
				{
					"Key": "Name",
					"Value": {
						"Fn::Join": [
							"-",
							[
								{
									"Ref": "AWS::StackName"
								},
								"DbSecurityGroup"
							]
						]
					}
				}
			]
		}
	},
	"DBSubnetGroup": {
		"Type": "AWS::RDS::DBSubnetGroup",
		"Properties": {
			"DBSubnetGroupDescription": "DB Subnet Group",
			"DBSubnetGroupName": {
				"Fn::Join": [
					"",
					[
						"SubnetGroup",
						{
							"Ref": "AWS::StackName"
						}
					]
				]
			},
			"SubnetIds": [
				{
					"Fn::ImportValue": "dbSubnet1"
				},
				{
					"Fn::ImportValue": "dbSubnet2"
				}
			]
		}
	},
	"EC2Instance": {
		"Type": "AWS::EC2::Instance",
		"Properties": {
			"SubnetId": {
				"Fn::ImportValue": "webSubnet"
			},
			"ImageId": {
				"Ref": "ImageID"
			},
			"KeyName": {
				"Ref": "KeyPair"
			},
			"InstanceType": "t2.micro",
			"BlockDeviceMappings": [
				{
					"DeviceName": "/dev/sda1",
					"Ebs": {
						"VolumeType": "gp2",
						"DeleteOnTermination": "true",
						"VolumeSize": "20"
					}
				}
			],
			"SecurityGroupIds": [
				{
					"Ref": "WebServerSecurityGroup"
				}
			],
			"Tags": [
				{
					"Key": "Name",
					"Value": {
						"Fn::Join": [
							"-",
							[
								{
									"Ref": "AWS::StackName"
								},
								"ec2"
							]
						]
					}
				}
			]
		}
	},
	"DynamoDBTable": {
		"Type": "AWS::DynamoDB::Table",
		"Properties": {
			"AttributeDefinitions": [
				{
					"AttributeName": "id",
					"AttributeType": "S"
				}
			],
			"KeySchema": [
				{
					"AttributeName": "id",
					"KeyType": "HASH"
				}
			],
			"ProvisionedThroughput": {
				"ReadCapacityUnits": "5",
				"WriteCapacityUnits": "5"
			},
			"TableName": "csye6225"
		}
	},
	"RDSDBInstance": {
		"Type": "AWS::RDS::DBInstance",
		"Properties": {
			"DBName": "csye6225",
			"DBInstanceClass": "db.t2.micro",
			"DBInstanceIdentifier": "csye6225-su19",
			"AllocatedStorage": "5",
			"Engine": "MySQL",
			"EngineVersion": "5.7.25",
			"MasterUsername": {
				"Ref": "DBUsername"
			},
			"MasterUserPassword": {
				"Ref": "DBPassword"
			},
			"MultiAZ": "false",
			"DBSubnetGroupName": {
				"Ref": "DBSubnetGroup"
			},
			"PubliclyAccessible": "true",
			"StorageType": "gp2",
			"VPCSecurityGroups": [
				{
					"Ref": "DbSecurityGroup"
				}
			],
			"Tags": [
				{
					"Key": "Name",
					"Value": {
						"Fn::Join": [
							"-",
							[
								{
									"Ref": "AWS::StackName"
								},
								"RDS"
							]
						]
					}
				}
			]
		}
	},
	"CODEDEPLOYAPPLICATION": {
		"Type": "AWS::CodeDeploy::Application",
		"Properties": [
			{
				"applicationName": "csye6225-webapp",
				"computePlatform": "Server"
			}
		]
	},
	"CODEDEPLOYDEPLOYMENTGROUP": {
		"Type": "AWS::CodeDeploy::DeploymentGroup",
		"Properties": {
			"applicationName": {
				"Ref": "CODEDEPLOYAPPLICATION"
			}
		},
		"deploymentGroupName": "csye6225-webapp-deployment",
		"serviceRoleArn": "NOTSURE",
		"deploymentStyle": {
			"deploymentType": "IN_PLACE"
		},
		"DeploymentConfigName": "CodeDeployDefault.AllAtOnce",
		"AutoRollbackConfiguration": {
			"Enabled": "true",
			"Events": [
				"DEPLOYMENT_FAILURE"
			]
		},
		"Ec2TagFilters": [
			{
				"Key": "Name",
				"Type": "KEY_AND_VALUE",
				"Value": {
					"Fn::Join": [
						"-",
						[
							{
								"Ref": "AWS::StackName"
							},
							"ec2"
						]
					]
				}
			}
		]
	}
}